{

  "ends" : [
    [0.5, "sbq_escortdiffspecies"],
    [1.0, "sbq_gift"]
  ],

  "quests" : {
    "sbq_escortdiffspecies" : {
      "templateId" : "escort.generated",
      "difficulty" : 0.2,
      "participants" : {
        "questGiver" : {
          "turnInQuest" : true
        }
      },

      "managerPlugins" : [
        {
          "script" : "/scripts/quest/manager/spawn_entities.lua",
          "pluginClass" : "SpawnEntities",
          "pluginConfig" : {
            "group" : "targets",
            "spawnCount" : 1,
            "positionParameter" : "spawnPoint",
            "persistent" : true,
            "spawnParameter" : "targetNpcType",

            "addEntityParameter" : "target",
            "relationships" : [
              ["likes", false, "questGiver"],
              ["likes", true, "questGiver"]
            ],
            "participantDef" : {
              "critical" : true,
              "behaviorOverrides" : [
                {
                  "type" : "notification",
                  "behavior" : {
                    "name" : "quest-escort-notification"
                  }
                },
                {
                  "type" : "follow",
                  "target" : "player",
                  "questFlag" : "interacted"
                },
                {
                  "type" : "follow",
                  "target" : "questGiver",
                  "questFlag" : "interacted"
                }
              ]
            }
          }
        }
      ],

      "preconditions" : [
        ["findLocation", "spawnPoint", "locationTags", 90, -1],
        ["tagSetContains", "locationTags", {"literal":"friendly"}],

        ["seededNpcType", "targetNpcType", "species", {"literal":"villager"}, {
          "damageTeamType" : "assistant"
        }],
        // The only change from the base escort.
        // Choose a random species that isn't the same as the quest giver.
        ["sbq_pickSpecies", "species"],
        ["!species", "questGiver", "species"]
      ],
      "postconditions" : [
      ]
    },

    "sbq_gift" : {
      "templateId" : "gift.generated",
      "difficulty" : 0.1,
      "participants" : {
        "questGiver" : {
          "behaviorOverrides" : [
            {
              "type" : "follow",
              "target" : "player"
            }
          ]
        },
        "target" : {
          "critical" : true,
          "behaviorOverrides" : [
            {
              "type" : "notification",
              "behavior" : { "name" : "quest-gift-notification" }
            },
            {
              "type" : "idle",
              "behavior" : { "name" : "quest-stay_at_home-idle" }
            }
          ]
        },
        "recipientDeed" : {
          "critical" : true
        }
      },

      "preconditions" : [
        // Fully copy-pasted from common.config
        ["itemList", "extraRewards", "money", "itemPrice"],
        ["itemName", "money", {"literal":"money"}],
        ["price", "gift", "itemPrice"],

        ["!likes", "target", "questGiver"],
        ["owns", "player", "gift", "origCount"],
        ["chooseGift", "target", "gift"],

        ["optionalDeed", "target", "recipientDeed"],
        [">=", "origCount", 1],
        ["+", "newCount", 1, "origCount"],
        ["isNpc", "target"],
        ["!=", "target", "questGiver"]
      ],
      "postconditions" : [
        ["likes", "target", "questGiver"],
        ["likes", "questGiver", "target"],
        ["!owns", "player", "gift", "origCount"],
        ["owns", "player", "gift", "newCount"]
      ],
      "objectives" : [
        ["likes", "target", "questGiver"]
      ]
    }

  }

}
